<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Confirmar Turno</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            margin-left: 220px; /* igual al ancho de la navbar */
        }
        @media (max-width: 991px) {
            nav.navbar {
                position: static !important;
                width: 100% !important;
                height: auto !important;
                border-right: none !important;
            }
            body {
                margin-left: 0 !important;
            }
        }
    </style>
</head>
<body>


    <nav class="navbar navbar-expand-lg navbar-light bg-light flex-column align-items-stretch"
         style="position: fixed; top: 0; left: 0; height: 100vh; width: 220px; z-index: 1030; border-right: 1px solid #eee; padding-top: 1rem;">
        <a class="navbar-brand mb-4" href="index.html" style="font-weight: 200; font-size: 30px;">Sentirse Bien</a>
        <ul class="navbar-nav flex-column w-100">
            <li class="nav-item mb-2">
                <a class="nav-link active" aria-current="page" href="#" style="font-weight: 100; font-size: 20px;">Inicio</a>
            </li>
            <li class="nav-item mb-2">
                <a class="nav-link" href="#contenedor-servicios" style="font-weight: 100; font-size: 20px;">Servicios</a>
            </li>
            <li class="nav-item mb-2">
                <a class="nav-link" href="#" style="font-weight: 100; font-size: 20px;">Acerca De</a>
            </li>
            <li class="nav-item mt-auto">
                <a class="nav-link" href="/cuenta.html" style="font-weight: 100; font-size: 20px;">Cuenta de Usuario</a>
            </li>
        </ul>
    </nav>

    <div class="container mt-5">
        <h2>Confirmar Solicitud de Turno</h2>
        <div id="datos-turno" class="mb-4"></div>
        <div id="turnos-agregados" class="mb-4"></div>
        <button id="agregarTurnoBtn" class="btn btn-secondary mb-2">Agregar otro turno</button>
        <div id="pago-section" style="display:none;">
            <h4>Simular Pago</h4>
            <form id="pagoForm" class="mb-3">
                <div class="mb-2">
                    <label class="form-label">Precio del Servicio:</label>
                    <input type="text" id="precioServicio" class="form-control" readonly>
                </div>
                <div class="mb-2">
                    <label class="form-label">Número de Tarjeta</label>
                    <input type="text" id="tarjeta" class="form-control" maxlength="16" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Código de Seguridad</label>
                    <input type="text" id="codigo" class="form-control" maxlength="3" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Fecha de Caducidad (MM/AA)</label>
                    <input type="text" id="caducidad" class="form-control" maxlength="5" placeholder="MM/AA" required>
                </div>
                <button type="submit" id="pagarBtn" class="btn btn-warning">Confirmar Pago de Turno</button>
            </form>
        </div>
        <button id="confirmarBtn" class="btn btn-success mb-2" style="display:none;">Confirmar y Solicitar Turno</button>
        <button id="descargarBtn" class="btn btn-primary" style="display:none;">Descargar PDF</button>
    </div>

    <!-- Modal para agregar turno -->
    <div class="modal fade" id="modalTurno" tabindex="-1" aria-labelledby="modalTurnoLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formNuevoTurno">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTurnoLabel">Agregar Nuevo Turno</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">Servicio</label>
                <select class="form-control" id="nuevoServicio" required>
                  <option value="">Seleccione un servicio</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">Profesional</label>
                <select class="form-control" id="nuevoProfesional" required>
                  <option value="">Seleccione un profesional</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">Fecha</label>
                <input type="date" class="form-control" id="nuevoFecha" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Hora de Inicio</label>
                <input type="time" class="form-control" id="nuevoHoraInicio" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Hora de Fin</label>
                <input type="time" class="form-control" id="nuevoHoraFin" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Email (Puede cargar otro correo si asi lo requiere!)</label>
                <input type="email" class="form-control" id="nuevoEmail" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Agregar Turno</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
        // Cambia la estructura para manejar múltiples turnos
        let turnos = JSON.parse(localStorage.getItem('turnosData')) || [];
        const datos = JSON.parse(localStorage.getItem('turnoData'));
        if (datos) {
            turnos.push(datos);
            localStorage.setItem('turnosData', JSON.stringify(turnos));
            localStorage.removeItem('turnoData');
        }

        const turnosDiv = document.getElementById('turnos-agregados');
        async function mostrarTurnos() {
            if (turnos.length === 0) {
                turnosDiv.innerHTML = '<div class="alert alert-danger">No hay turnos para confirmar.</div>';
                document.getElementById('pago-section').style.display = 'none';
                return;
            }
            let html = '<h5>Turnos agregados:</h5><ul class="list-group">';
            for (let i = 0; i < turnos.length; i++) {
                const t = turnos[i];
                // Obtener nombre del servicio
                let servicioNombre = t.servicio_id;
                let profesionalNombre = t.profesional_id;
                try {
                    const resServicio = await fetch(`/api/servicios/${t.servicio_id}`);
                    const servicio = await resServicio.json();
                    servicioNombre = servicio.nombre || t.servicio_id;
                } catch {}
                try {
                    const resProfesional = await fetch(`/api/profesionales/${t.profesional_id}`);
                    const profesional = await resProfesional.json();
                    profesionalNombre = profesional.nombre || t.profesional_id;
                } catch {}
                html += `<li class="list-group-item">
                    <strong>Servicio:</strong> ${servicioNombre} | 
                    <strong>Profesional:</strong> ${profesionalNombre} | 
                    <strong>Fecha:</strong> ${t.fecha} | 
                    <strong>Hora:</strong> ${t.hora_inicio} - ${t.hora_fin}
                    <button class="btn btn-sm btn-danger float-end" onclick="eliminarTurno(${i})">Eliminar</button>
                </li>`;
            }
            html += '</ul>';
            turnosDiv.innerHTML = html;
        }

        window.eliminarTurno = function(idx) {
            turnos.splice(idx, 1);
            localStorage.setItem('turnosData', JSON.stringify(turnos));
            mostrarTurnos();
            calcularPago();
        };

        async function cargarOpcionesServiciosYProfesionales() {
            // Servicios
            const servicioSelect = document.getElementById('nuevoServicio');
            servicioSelect.innerHTML = '<option value="">Seleccione un servicio</option>';
            try {
                const res = await fetch('/api/servicios');
                const servicios = await res.json();
                servicios.forEach(servicio => {
                    const opt = document.createElement('option');
                    opt.value = servicio.id || servicio.ID_SERVICIO;
                    opt.textContent = servicio.nombre;
                    servicioSelect.appendChild(opt);
                });
            } catch {}

            // Profesionales
            const profesionalSelect = document.getElementById('nuevoProfesional');
            profesionalSelect.innerHTML = '<option value="">Seleccione un profesional</option>';
            try {
                const res = await fetch('/api/profesionales');
                const profesionales = await res.json();
                profesionales.forEach(prof => {
                    const opt = document.createElement('option');
                    opt.value = prof.id || prof.ID_PROFESIONAL;
                    opt.textContent = prof.nombre;
                    profesionalSelect.appendChild(opt);
                });
            } catch {}
        }

        document.getElementById('agregarTurnoBtn').onclick = function() {
            cargarOpcionesServiciosYProfesionales().then(() => {
                const modal = new bootstrap.Modal(document.getElementById('modalTurno'));
                modal.show();
            });
        };

        // Calcular si todos los turnos son el mismo día
        async function calcularPago() {
            if (turnos.length === 0) return;
            const fechas = turnos.map(t => t.fecha);
            const mismoDia = fechas.every(f => f === fechas[0]);
            let total = 0;
            let aplicaDescuento = false;
            let detalles = [];
            for (const t of turnos) {
                const res = await fetch(`/api/servicios/${t.servicio_id}`);
                const servicio = await res.json();
                let precio = servicio.precio;
                const fechaTurno = new Date(`${t.fecha}T${t.hora_inicio}`);
                const ahora = new Date();
                const ms48hs = 48 * 60 * 60 * 1000;
                if (fechaTurno - ahora > ms48hs) {
                    precio = Math.round(precio * 0.85);
                    aplicaDescuento = true;
                }
                total += precio;
                detalles.push(`${servicio.nombre}: ${precio} ARS`);
            }
            const precioServicioInput = document.getElementById('precioServicio');
            if (mismoDia) {
                precioServicioInput.value = `${total} ARS${aplicaDescuento ? ' (15% OFF)' : ''}`;
                precioServicioInput.dataset.precio = total;
                document.getElementById('pago-section').style.display = 'block';
                document.getElementById('pagarBtn').disabled = false;
            } else {
                precioServicioInput.value = 'No disponible (turnos en días distintos)';
                precioServicioInput.dataset.precio = '';
                document.getElementById('pago-section').style.display = 'block';
                document.getElementById('pagarBtn').disabled = true;
            }
            // Mensaje informativo
            let info = `<div class="alert alert-danger mt-2">
                <ul style="margin-bottom:0;">
                    <li>Si el pago se realiza por la web antes de las 48 hs del servicio se recibe un descuento del 15%.</li>
                    <li>Solo se puede pagar a través de tarjeta de débito. Caso contrario se paga el precio de lista.</li>
                    <li>El cliente puede seleccionar más de un servicio. En este caso se puede realizar un solo pago siempre y cuando se realicen las atenciones en el mismo día. Si el servicio es en distintos días se paga por separado.</li>
                </ul>
            </div>`;
            document.getElementById('pago-section').querySelectorAll('.alert').forEach(e => e.remove());
            document.getElementById('pago-section').prepend(document.createRange().createContextualFragment(info));
        }

        mostrarTurnos();
        calcularPago();

        // Modifica el submit del pago para enviar todos los turnos
        document.getElementById('pagoForm').onsubmit = function(e) {
            e.preventDefault();
            if (document.getElementById('pagarBtn').disabled) {
                alert('No se puede pagar turnos en días distintos juntos.');
                return;
            }
            const tarjeta = document.getElementById('tarjeta').value.trim();
            const codigo = document.getElementById('codigo').value.trim();
            const caducidad = document.getElementById('caducidad').value.trim();

            // Validaciones simples
            const tarjetaValida = /^\d{16}$/.test(tarjeta); //numero valido de tarjeta de 16 dígitos por ejemplo: // 1234567812345678
            const codigoValido = /^\d{3}$/.test(codigo);
            const caducidadValida = /^(0[1-9]|1[0-2])\/\d{2}$/.test(caducidad); // fecha de caducidad en formato MM/AA valida de ejemplo: 12/25

            if (!tarjetaValida) {
                alert('Número de tarjeta inválido');
                return;
            }
            if (!codigoValido) {
                alert('Código de seguridad inválido');
                return;
            }
            if (!caducidadValida) {
                alert('Fecha de caducidad inválida');
                return;
            }

            // Simular pago exitoso
            alert('Pago realizado con éxito.');
            document.getElementById('confirmarBtn').style.display = 'inline-block';
            document.getElementById('pago-section').style.display = 'none';
        };

        // Modifica el confirmar para enviar todos los turnos
        document.getElementById('confirmarBtn').onclick = async function() {
            for (const t of turnos) {
                const turnoData = {
                    servicio_id: t.servicio_id,
                    profesional_id: t.profesional_id,
                    fecha_inicio: `${t.fecha}T${t.hora_inicio}`,
                    fecha_finalizacion: `${t.fecha}T${t.hora_fin}`,
                    email: t.email,
                    estado: 'pendiente'
                };
                await fetch('/api/turnos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(turnoData)
                });
            }
            alert('Turnos solicitados exitosamente.');
            document.getElementById('descargarBtn').style.display = 'inline-block';
            this.style.display = 'none';
            localStorage.removeItem('turnosData');
        };

        // Modifica el PDF para mostrar todos los turnos
        document.getElementById('descargarBtn').onclick = async function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(40);
            doc.text('- Comprobante de Solicitud de Turnos - SPA Sentirse Bien -', 10, 10);
            let y = 20;

            // Obtener nombres de servicios y profesionales
            const turnosConNombres = await Promise.all(turnos.map(async (t) => {
                let servicioNombre = t.servicio_id;
                let profesionalNombre = t.profesional_id;
                try {
                    const resServicio = await fetch(`/api/servicios/${t.servicio_id}`);
                    const servicio = await resServicio.json();
                    servicioNombre = servicio.nombre || t.servicio_id;
                } catch {}
                try {
                    const resProfesional = await fetch(`/api/profesionales/${t.profesional_id}`);
                    const profesional = await resProfesional.json();
                    profesionalNombre = profesional.nombre || t.profesional_id;
                } catch {}
                return { ...t, servicioNombre, profesionalNombre };
            }));

            turnosConNombres.forEach((t, idx) => {
                doc.setFontSize(12);
                doc.text(`Turno ${idx + 1}:`, 10, y);
                y += 8;
                doc.text(`Email: ${t.email}`, 10, y);
                y += 8;
                doc.text(`Servicio: ${t.servicioNombre}`, 10, y);
                y += 8;
                doc.text(`Profesional: ${t.profesionalNombre}`, 10, y);
                y += 8;
                doc.text(`Fecha: ${t.fecha}`, 10, y);
                y += 8;
                doc.text(`Hora de Inicio: ${t.hora_inicio}`, 10, y);
                y += 8;
                doc.text(`Hora de Fin: ${t.hora_fin}`, 10, y);
                y += 10;
            });
            doc.text(`Precio total: ${document.getElementById('precioServicio').value}`, 10, y);
            doc.save('comprobante-turnos.pdf');
        };

        document.getElementById('formNuevoTurno').onsubmit = function(e) {
            e.preventDefault();
            const nuevoTurno = {
                servicio_id: document.getElementById('nuevoServicio').value.trim(),
                profesional_id: document.getElementById('nuevoProfesional').value.trim(),
                fecha: document.getElementById('nuevoFecha').value,
                hora_inicio: document.getElementById('nuevoHoraInicio').value,
                hora_fin: document.getElementById('nuevoHoraFin').value,
                email: document.getElementById('nuevoEmail').value.trim()
            };
            // Validación simple
            if (!nuevoTurno.servicio_id || !nuevoTurno.profesional_id || !nuevoTurno.fecha ||
                !nuevoTurno.hora_inicio || !nuevoTurno.hora_fin || !nuevoTurno.email) {
                alert('Completa todos los campos.');
                return;
            }
            turnos.push(nuevoTurno);
            localStorage.setItem('turnosData', JSON.stringify(turnos));
            mostrarTurnos();
            calcularPago();
            // Cierra el modal
            bootstrap.Modal.getInstance(document.getElementById('modalTurno')).hide();
            // Limpia el formulario
            this.reset();
        };

        document.getElementById('nuevoHoraInicio').addEventListener('change', function() {
            const inicio = this.value;
            if (inicio) {
                // Parsear la hora de inicio
                const [h, m] = inicio.split(':').map(Number);
                let finH = h + 1;
                let finM = m;
                if (finH >= 24) finH -= 24; // Ajuste para formato 24hs
                // Formatear con ceros a la izquierda
                const finStr = `${finH.toString().padStart(2, '0')}:${finM.toString().padStart(2, '0')}`;
                document.getElementById('nuevoHoraFin').value = finStr;
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>